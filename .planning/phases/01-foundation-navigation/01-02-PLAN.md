---
phase: 01-foundation-navigation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/App.tsx
  - src/components/layout/Layout.tsx
  - src/components/layout/BackButton.tsx
  - src/components/home/HomePage.tsx
  - src/components/home/SectionCard.tsx
  - src/hooks/useIframeHeight.ts
  - src/types/navigation.ts
  - src/data/sections.ts
autonomous: true

must_haves:
  truths:
    - "User sees loading screen on initial load for 1.5 seconds"
    - "User sees home page with 3 entry cards after loading"
    - "User can tap a card to navigate to that section"
    - "User sees back button when in a section (not on home)"
    - "User can tap back button to return to home"
    - "iframe height is communicated to parent via postMessage"
  artifacts:
    - path: "src/App.tsx"
      provides: "Root component with loading state and view navigation"
      contains: "useState"
    - path: "src/components/layout/Layout.tsx"
      provides: "Main layout wrapper with iframe height hook"
      exports: ["Layout"]
    - path: "src/components/layout/BackButton.tsx"
      provides: "Back navigation button with arrow icon"
      exports: ["BackButton"]
    - path: "src/components/home/HomePage.tsx"
      provides: "Home view with 3 section entry cards"
      exports: ["HomePage"]
    - path: "src/components/home/SectionCard.tsx"
      provides: "Clickable card for section navigation"
      exports: ["SectionCard"]
    - path: "src/hooks/useIframeHeight.ts"
      provides: "ResizeObserver + postMessage hook for iframe height sync"
      exports: ["useIframeHeight"]
    - path: "src/types/navigation.ts"
      provides: "View type definition"
      exports: ["View"]
  key_links:
    - from: "src/App.tsx"
      to: "src/components/layout/Layout.tsx"
      via: "component import and render"
      pattern: "import.*Layout"
    - from: "src/components/layout/Layout.tsx"
      to: "src/hooks/useIframeHeight.ts"
      via: "hook call"
      pattern: "useIframeHeight\\(\\)"
    - from: "src/components/home/HomePage.tsx"
      to: "navigate callback"
      via: "SectionCard onClick"
      pattern: "onNavigate"
    - from: "src/hooks/useIframeHeight.ts"
      to: "window.parent.postMessage"
      via: "ResizeObserver callback"
      pattern: "postMessage.*IFRAME_HEIGHT"
---

<objective>
Implement the Layout component with iframe height synchronization, state-based navigation system, and home page with 3 entry cards.

Purpose: Complete Phase 1 by enabling users to navigate between home and section views, with proper iframe integration for Circle.so embedding.
Output: Fully functional home page with working navigation to section placeholders.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-navigation/01-RESEARCH.md
@.planning/phases/01-foundation-navigation/01-01-SUMMARY.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create navigation types and iframe height hook</name>
  <files>
    src/types/navigation.ts
    src/hooks/useIframeHeight.ts
  </files>
  <action>
1. Create `src/types/navigation.ts`:
```typescript
export type View = 'home' | 'unpleasant' | 'pleasant' | 'steps';
```

2. Create `src/hooks/useIframeHeight.ts`:
```typescript
import { useEffect } from 'react';

const FALLBACK_HEIGHT = 900;

export function useIframeHeight() {
  useEffect(() => {
    const sendHeight = () => {
      try {
        const height = document.documentElement.scrollHeight;
        window.parent.postMessage(
          { type: 'IFRAME_HEIGHT', height },
          '*'
        );
      } catch (e) {
        // postMessage failed, parent will use fallback
        console.warn('postMessage failed, parent should use fallback:', FALLBACK_HEIGHT);
      }
    };

    // Initial send after a brief delay to ensure content is rendered
    const initialTimeout = setTimeout(sendHeight, 100);

    // Watch for content changes
    const observer = new ResizeObserver(() => {
      sendHeight();
    });
    observer.observe(document.body);

    // Also send on window load
    window.addEventListener('load', sendHeight);

    return () => {
      clearTimeout(initialTimeout);
      observer.disconnect();
      window.removeEventListener('load', sendHeight);
    };
  }, []);
}
```

IMPORTANT: The hook uses ResizeObserver (not polling) for efficiency. The FALLBACK_HEIGHT constant (900px) matches TECH-02 requirement.
  </action>
  <verify>
Files exist at correct paths, TypeScript compiles without errors
  </verify>
  <done>
View type defines 4 views (home, unpleasant, pleasant, steps), useIframeHeight hook posts height messages via ResizeObserver
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Layout and BackButton components</name>
  <files>
    src/components/layout/Layout.tsx
    src/components/layout/BackButton.tsx
  </files>
  <action>
1. Create `src/components/layout/Layout.tsx`:
```typescript
import { ReactNode } from 'react';
import { useIframeHeight } from '../../hooks/useIframeHeight';

interface LayoutProps {
  children: ReactNode;
}

export function Layout({ children }: LayoutProps) {
  // Sync iframe height with parent
  useIframeHeight();

  return (
    <div className="min-h-screen bg-bg-primary text-text-primary">
      <main className="max-w-2xl mx-auto px-4 py-6">
        {children}
      </main>
    </div>
  );
}
```

2. Create `src/components/layout/BackButton.tsx`:
```typescript
import { ArrowLeft } from 'lucide-react';

interface BackButtonProps {
  onClick: () => void;
}

export function BackButton({ onClick }: BackButtonProps) {
  return (
    <button
      onClick={onClick}
      className="flex items-center gap-2 text-text-secondary hover:text-text-primary transition-colors mb-6 min-h-[44px] min-w-[44px]"
      aria-label="Retour a l'accueil"
    >
      <ArrowLeft size={24} />
      <span className="text-sm font-medium">Retour</span>
    </button>
  );
}
```

IMPORTANT:
- Layout has NO persistent header (NAV-03) - just a container
- BackButton has 44x44px minimum touch target for accessibility
- BackButton only shown when not on home (handled by App.tsx)
  </action>
  <verify>
TypeScript compiles without errors, imports resolve correctly
  </verify>
  <done>
Layout wraps content with max-width container and calls useIframeHeight, BackButton renders accessible arrow button
  </done>
</task>

<task type="auto">
  <name>Task 3: Create HomePage, SectionCard, and wire up App navigation</name>
  <files>
    src/data/sections.ts
    src/components/home/SectionCard.tsx
    src/components/home/HomePage.tsx
    src/App.tsx
  </files>
  <action>
1. Create `src/data/sections.ts`:
```typescript
import { View } from '../types/navigation';

export interface Section {
  id: View;
  title: string;
  subtitle: string;
  description: string;
  color: string; // Tailwind class for background
  textColor: string; // Tailwind class for text on colored bg
}

export const sections: Section[] = [
  {
    id: 'unpleasant',
    title: 'Quand ca ne va pas',
    subtitle: '7 emotions',
    description: 'Explorer les emotions desagreables et comprendre leurs messages',
    color: 'bg-red',
    textColor: 'text-white',
  },
  {
    id: 'pleasant',
    title: 'Quand ca va bien',
    subtitle: '6 sentiments',
    description: 'Decouvrir les sentiments agreables et leurs origines',
    color: 'bg-mint',
    textColor: 'text-bg-primary',
  },
  {
    id: 'steps',
    title: 'Les 5 etapes',
    subtitle: 'Regulation emotionnelle',
    description: 'Apprendre a traverser une emotion en 5 etapes',
    color: 'bg-brand-primary',
    textColor: 'text-white',
  },
];
```

2. Create `src/components/home/SectionCard.tsx`:
```typescript
import { ChevronRight } from 'lucide-react';
import { Section } from '../../data/sections';

interface SectionCardProps {
  section: Section;
  onClick: () => void;
}

export function SectionCard({ section, onClick }: SectionCardProps) {
  return (
    <button
      onClick={onClick}
      className={`w-full p-6 rounded-2xl ${section.color} ${section.textColor} text-left transition-transform hover:scale-[1.02] active:scale-[0.98] min-h-[120px]`}
    >
      <div className="flex justify-between items-start">
        <div>
          <p className="text-sm opacity-80 mb-1">{section.subtitle}</p>
          <h2 className="text-xl font-semibold mb-2">{section.title}</h2>
          <p className="text-sm opacity-90">{section.description}</p>
        </div>
        <ChevronRight size={24} className="flex-shrink-0 opacity-80" />
      </div>
    </button>
  );
}
```

3. Create `src/components/home/HomePage.tsx`:
```typescript
import { View } from '../../types/navigation';
import { sections } from '../../data/sections';
import { SectionCard } from './SectionCard';

interface HomePageProps {
  onNavigate: (view: View) => void;
}

export function HomePage({ onNavigate }: HomePageProps) {
  return (
    <div>
      {/* Brand header */}
      <header className="text-center mb-8">
        <h1 className="font-brand text-2xl italic font-black text-text-primary mb-2">
          Cartes des Emotions
        </h1>
        <p className="text-text-secondary text-sm">
          Explorez et comprenez vos emotions
        </p>
      </header>

      {/* Section cards */}
      <div className="flex flex-col gap-4">
        {sections.map((section) => (
          <SectionCard
            key={section.id}
            section={section}
            onClick={() => onNavigate(section.id)}
          />
        ))}
      </div>
    </div>
  );
}
```

4. Update `src/App.tsx` to wire everything together:
```typescript
import { useState, useEffect } from 'react';
import { View } from './types/navigation';
import { Layout } from './components/layout/Layout';
import { BackButton } from './components/layout/BackButton';
import { LoadingScreen } from './components/ui/LoadingScreen';
import { HomePage } from './components/home/HomePage';

function App() {
  const [isLoading, setIsLoading] = useState(true);
  const [currentView, setCurrentView] = useState<View>('home');

  // Loading screen timer (TECH-04)
  useEffect(() => {
    const timer = setTimeout(() => setIsLoading(false), 1500);
    return () => clearTimeout(timer);
  }, []);

  const navigate = (view: View) => setCurrentView(view);
  const goHome = () => setCurrentView('home');

  // Show loading screen
  if (isLoading) {
    return <LoadingScreen />;
  }

  return (
    <Layout>
      {/* Back button - only shown when not on home (NAV-02) */}
      {currentView !== 'home' && <BackButton onClick={goHome} />}

      {/* View routing */}
      {currentView === 'home' && <HomePage onNavigate={navigate} />}
      {currentView === 'unpleasant' && (
        <div className="text-center py-12">
          <h2 className="text-xl font-semibold mb-2">Quand ca ne va pas</h2>
          <p className="text-text-secondary">7 emotions - A venir dans Phase 2</p>
        </div>
      )}
      {currentView === 'pleasant' && (
        <div className="text-center py-12">
          <h2 className="text-xl font-semibold mb-2">Quand ca va bien</h2>
          <p className="text-text-secondary">6 sentiments - A venir dans Phase 2</p>
        </div>
      )}
      {currentView === 'steps' && (
        <div className="text-center py-12">
          <h2 className="text-xl font-semibold mb-2">Les 5 etapes</h2>
          <p className="text-text-secondary">Regulation emotionnelle - A venir dans Phase 4</p>
        </div>
      )}
    </Layout>
  );
}

export default App;
```

IMPORTANT:
- Loading screen shows for 1.5 seconds (branded experience)
- State-based navigation (no React Router) per research findings
- BackButton only appears when not on home (NAV-02, NAV-03)
- Section views are placeholders for now (Phase 2 and 4 will implement)
  </action>
  <verify>
1. Run `npm run dev`
2. Observe loading screen for ~1.5 seconds
3. See home page with 3 colored cards
4. Click any card - navigates to placeholder section
5. See back button appear
6. Click back button - returns to home
7. Open browser console - see IFRAME_HEIGHT postMessage calls (use window.addEventListener to verify)
  </verify>
  <done>
Home page displays 3 entry cards (red/mint/blue), clicking navigates to section placeholders, back button returns to home, iframe height is posted to parent
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify Phase 1 success criteria:

1. **Home page with 3 entry cards** - User sees "Quand ca ne va pas" (red), "Quand ca va bien" (mint), "Les 5 etapes" (blue)
2. **Navigation works** - Clicking any card navigates to that section's placeholder view
3. **Back button** - Appears in section views, clicking returns to home
4. **Loading screen** - Shows "Cartes des Emotions" with spinner for ~1.5s on initial load
5. **iframe height** - Open DevTools console, verify `IFRAME_HEIGHT` messages are posted

Manual verification commands:
```bash
npm run dev
# Open http://localhost:5173 in browser
# Test all navigation flows
```

To verify postMessage in browser console:
```javascript
window.addEventListener('message', (e) => console.log('Message:', e.data));
```
</verification>

<success_criteria>
- Loading screen shows on initial load with branded typography
- Home page displays 3 colored section cards
- Tapping any card navigates to section (shows placeholder)
- Back button appears in sections and returns to home
- No persistent header exists (clean UI)
- iframe height is communicated via postMessage with ResizeObserver
- All Phase 1 requirements (NAV-01, NAV-02, NAV-03, TECH-01, TECH-02, TECH-04) are met
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-navigation/01-02-SUMMARY.md`
</output>
