---
phase: 03-slide-in-panel-details
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/hooks/usePrefersReducedMotion.ts
  - src/components/panel/SlidePanel.tsx
  - src/components/panel/PanelHeader.tsx
autonomous: true

must_haves:
  truths:
    - "Panel slides up from bottom with 300ms animation"
    - "Panel can be closed via Escape key"
    - "Panel backdrop is semi-transparent black"
    - "Focus is trapped inside panel while open"
    - "Animation respects prefers-reduced-motion"
  artifacts:
    - path: "src/hooks/usePrefersReducedMotion.ts"
      provides: "Motion preference detection hook"
      exports: ["usePrefersReducedMotion"]
    - path: "src/components/panel/SlidePanel.tsx"
      provides: "Base slide-up panel using native dialog"
      exports: ["SlidePanel"]
    - path: "src/components/panel/PanelHeader.tsx"
      provides: "Reusable header with close and back buttons"
      exports: ["PanelHeader"]
  key_links:
    - from: "src/components/panel/SlidePanel.tsx"
      to: "dialog.showModal()"
      via: "useEffect on isOpen"
      pattern: "showModal\\(\\)"
    - from: "src/components/panel/SlidePanel.tsx"
      to: "react-swipeable"
      via: "useSwipeable hook"
      pattern: "useSwipeable"
---

<objective>
Create the slide-in panel foundation with native HTML dialog, swipe-to-close gesture support, and accessibility features.

Purpose: Establish the base panel component that all emotion/sentiment detail views will use, with proper focus trapping, keyboard navigation, and motion preferences.
Output: SlidePanel and PanelHeader components ready for content integration, plus usePrefersReducedMotion hook.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-slide-in-panel-details/03-RESEARCH.md
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-swipeable and create motion preference hook</name>
  <files>
    package.json
    package-lock.json
    src/hooks/usePrefersReducedMotion.ts
  </files>
  <action>
1. Install react-swipeable:
   ```bash
   npm install react-swipeable
   ```

2. Create `src/hooks/usePrefersReducedMotion.ts`:
   - Query: `(prefers-reduced-motion: no-preference)`
   - Default to true (reduced motion) for SSR safety
   - Listen for changes via addEventListener('change')
   - Clean up listener on unmount
   - Return boolean: true = user prefers reduced motion

Reference pattern from RESEARCH.md:
```typescript
const QUERY = '(prefers-reduced-motion: no-preference)';

export function usePrefersReducedMotion(): boolean {
  const [prefersReducedMotion, setPrefersReducedMotion] = useState(true);

  useEffect(() => {
    const mediaQuery = window.matchMedia(QUERY);
    setPrefersReducedMotion(!mediaQuery.matches);

    const listener = (event: MediaQueryListEvent) => {
      setPrefersReducedMotion(!event.matches);
    };

    mediaQuery.addEventListener('change', listener);
    return () => mediaQuery.removeEventListener('change', listener);
  }, []);

  return prefersReducedMotion;
}
```
  </action>
  <verify>
    - `npm ls react-swipeable` shows 7.0.x installed
    - `src/hooks/usePrefersReducedMotion.ts` exports the hook
    - No TypeScript errors: `npx tsc --noEmit`
  </verify>
  <done>
    - react-swipeable installed in package.json
    - usePrefersReducedMotion hook created and exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SlidePanel base component with dialog and swipe</name>
  <files>
    src/components/panel/SlidePanel.tsx
  </files>
  <action>
Create `src/components/panel/SlidePanel.tsx`:

Props interface:
```typescript
interface SlidePanelProps {
  isOpen: boolean;
  onClose: () => void;
  children: React.ReactNode;
  color?: string;  // Background color class, default 'bg-bg-secondary'
}
```

Implementation requirements:

1. **Native dialog element:**
   - Use `<dialog>` with ref
   - Call `dialogRef.current.showModal()` when isOpen becomes true
   - Call `dialogRef.current.close()` when isOpen becomes false
   - Add `onClose={onClose}` to handle Escape key (native dialog behavior)

2. **Backdrop click to close:**
   - onClick on dialog element: if `e.target === e.currentTarget`, call onClose
   - This works because dialog's ::backdrop doesn't receive clicks, but the dialog itself does when clicking outside inner content

3. **Body scroll lock:**
   - useEffect: when isOpen, set `document.body.style.overflow = 'hidden'`
   - Restore on close or unmount

4. **Swipe-to-close:**
   - Use useSwipeable hook from react-swipeable
   - Track dragOffset state for visual feedback during swipe
   - onSwiping: if direction is 'Down', set dragOffset to deltaY (minimum 0)
   - onSwipedDown: if deltaY > 100 OR velocity > 0.5, call onClose
   - Reset dragOffset on touch end
   - Apply transform translateY(dragOffset) to inner wrapper

5. **Animation:**
   - Use usePrefersReducedMotion hook
   - Inner wrapper has: `transition-transform duration-300 ease-out` (when motion allowed)
   - Initial state: translate-y-full (off screen)
   - Open state: translate-y-0
   - Use state to track animation: when closing, wait for animation before dialog.close()

6. **Styling (Tailwind):**
   - Dialog: `fixed inset-0 m-0 max-h-full max-w-full p-0 bg-transparent`
   - Dialog backdrop: use CSS in index.css for `dialog::backdrop { background: rgba(0,0,0,0.5); }`
   - Inner wrapper: `fixed bottom-0 left-0 right-0 ${color} rounded-t-2xl max-h-[85vh] overflow-y-auto`

7. **Focus return:**
   - Store activeElement ref before opening
   - On close, return focus to stored element after animation

Critical: Animate the INNER wrapper, not the dialog itself. Dialog uses display:none which cannot be animated.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Component file exists with all props
    - useSwipeable imported and used
    - dialog element with showModal pattern present
  </verify>
  <done>
    - SlidePanel component renders native dialog with slide-up animation
    - Swipe down gesture closes panel (100px threshold or 0.5 velocity)
    - Escape key closes panel (native dialog)
    - Body scroll locked while open
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PanelHeader component with close and back buttons</name>
  <files>
    src/components/panel/PanelHeader.tsx
  </files>
  <action>
Create `src/components/panel/PanelHeader.tsx`:

Props interface:
```typescript
interface PanelHeaderProps {
  title: string;
  onClose: () => void;
  onBack?: () => void;  // Optional - shows back arrow instead of just X when present
  color?: string;       // Emotion color for accent
}
```

Implementation:

1. **Structure:**
   - Sticky header (`sticky top-0`)
   - Flex row with items-center
   - Back button (if onBack), title, close button

2. **Back button (optional):**
   - Render ChevronLeft icon from lucide-react
   - aria-label="Retour"
   - 44x44px touch target: `p-2 -ml-2` with rounded-full
   - hover:bg-white/10, focus ring

3. **Title:**
   - `<h2>` with flex-1
   - text-lg font-semibold

4. **Close button:**
   - X icon from lucide-react
   - aria-label="Fermer"
   - 44x44px touch target
   - If no back button, autoFocus this button (first focusable element)

5. **Styling:**
   - Background matches panel (bg-bg-secondary or custom color)
   - Bottom border: border-b border-white/10
   - Padding: px-4 py-3

6. **Drag handle indicator:**
   - Add small horizontal bar at top center as visual swipe indicator
   - `<div className="w-10 h-1 bg-white/30 rounded-full mx-auto mb-2" />`
   - Place BEFORE the flex row
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - ChevronLeft and X imported from lucide-react
    - autoFocus on close button when no back button
  </verify>
  <done>
    - PanelHeader renders with title and close button
    - Back button appears when onBack prop provided
    - Drag handle visual indicator present
    - 44x44px touch targets on buttons
  </done>
</task>

</tasks>

<verification>
After all tasks:

1. **Build check:**
   ```bash
   npm run build
   ```
   Should complete without errors.

2. **Type check:**
   ```bash
   npx tsc --noEmit
   ```
   No type errors.

3. **File structure:**
   ```
   src/
   ├── hooks/
   │   └── usePrefersReducedMotion.ts
   └── components/
       └── panel/
           ├── SlidePanel.tsx
           └── PanelHeader.tsx
   ```

4. **Dependencies:**
   - react-swipeable in package.json dependencies
</verification>

<success_criteria>
- react-swipeable installed and importable
- usePrefersReducedMotion hook detects user preference
- SlidePanel renders native dialog with showModal()
- SlidePanel animates in/out with 300ms slide
- SlidePanel closes on Escape, backdrop click, and swipe down
- PanelHeader shows close button (always) and back button (when prop provided)
- All components type-check without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-slide-in-panel-details/03-01-SUMMARY.md`
</output>
