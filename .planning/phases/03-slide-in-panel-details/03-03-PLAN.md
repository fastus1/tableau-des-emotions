---
phase: 03-slide-in-panel-details
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/emotions/UnpleasantEmotionsPage.tsx
  - src/components/emotions/PleasantSentimentsPage.tsx
  - src/index.css
autonomous: false

must_haves:
  truths:
    - "User taps emotion card and panel slides up with details"
    - "User taps sentiment card and panel slides up with details"
    - "User taps Culpabilite and sees 4 sub-cards"
    - "Panel closes via X button, Escape, overlay tap, and swipe down"
    - "Keyboard navigation works (Tab cycles through panel, Escape closes)"
  artifacts:
    - path: "src/components/emotions/UnpleasantEmotionsPage.tsx"
      provides: "Page with panel integration for 7 emotions"
      contains: "EmotionPanel|CulpabilitePanel"
    - path: "src/components/emotions/PleasantSentimentsPage.tsx"
      provides: "Page with panel integration for 6 sentiments"
      contains: "SentimentPanel"
    - path: "src/index.css"
      provides: "Dialog backdrop styling"
      contains: "dialog::backdrop"
  key_links:
    - from: "src/components/emotions/UnpleasantEmotionsPage.tsx"
      to: "EmotionPanel/CulpabilitePanel"
      via: "selectedEmotion state"
      pattern: "useState.*Emotion.*null"
    - from: "src/components/emotions/PleasantSentimentsPage.tsx"
      to: "SentimentPanel"
      via: "selectedSentiment state"
      pattern: "useState.*Sentiment.*null"
---

<objective>
Wire the panel components into the emotion and sentiment pages, add dialog backdrop styling, and verify the complete panel system works with all interaction methods.

Purpose: Complete the panel integration so users can explore emotion details by tapping cards.
Output: Fully functional panel system with human verification of all interaction patterns.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-slide-in-panel-details/03-RESEARCH.md
@src/types/emotions.ts
@src/data/emotions.ts
@src/data/sentiments.ts
@src/components/panel/SlidePanel.tsx
@src/components/panel/EmotionPanel.tsx
@src/components/panel/SentimentPanel.tsx
@src/components/panel/CulpabilitePanel.tsx
@src/components/emotions/UnpleasantEmotionsPage.tsx
@src/components/emotions/PleasantSentimentsPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dialog backdrop CSS</name>
  <files>
    src/index.css
  </files>
  <action>
Add to `src/index.css` (after existing styles):

```css
/* Dialog backdrop styling */
dialog::backdrop {
  background-color: rgba(0, 0, 0, 0.5);
}

/* Ensure dialog has no default styling interfering */
dialog {
  border: none;
  padding: 0;
  background: transparent;
}

dialog[open] {
  display: flex;
}
```

This ensures:
- Semi-transparent black backdrop (50% opacity)
- No default browser dialog styling
- Proper flex display when open
  </action>
  <verify>
    - CSS rules present in index.css
    - No syntax errors (build completes)
  </verify>
  <done>
    - Dialog backdrop styled as semi-transparent black
    - Default dialog border/padding removed
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire panels into UnpleasantEmotionsPage</name>
  <files>
    src/components/emotions/UnpleasantEmotionsPage.tsx
  </files>
  <action>
Update `src/components/emotions/UnpleasantEmotionsPage.tsx`:

1. **Add imports:**
   ```typescript
   import type { Emotion, CulpabiliteEmotion } from '../../types/emotions';
   import { isCulpabilite } from '../../types/emotions';
   import { EmotionPanel } from '../panel/EmotionPanel';
   import { CulpabilitePanel } from '../panel/CulpabilitePanel';
   ```

2. **Add state for selected emotion:**
   ```typescript
   const [selectedEmotion, setSelectedEmotion] = useState<Emotion | CulpabiliteEmotion | null>(null);
   ```

3. **Update handleCardClick:**
   ```typescript
   const handleCardClick = (emotion: Emotion | CulpabiliteEmotion) => {
     setSelectedEmotion(emotion);
   };
   ```

4. **Update EmotionCard onClick to pass full emotion:**
   ```tsx
   onClick={() => handleCardClick(emotion)}
   ```

5. **Render appropriate panel based on selection:**
   ```tsx
   {/* After the grid div */}
   {selectedEmotion && (
     isCulpabilite(selectedEmotion) ? (
       <CulpabilitePanel
         emotion={selectedEmotion}
         icon={emotionIcons[selectedEmotion.id]}
         isOpen={selectedEmotion !== null}
         onClose={() => setSelectedEmotion(null)}
       />
     ) : (
       <EmotionPanel
         emotion={selectedEmotion}
         icon={emotionIcons[selectedEmotion.id]}
         isOpen={selectedEmotion !== null}
         onClose={() => setSelectedEmotion(null)}
       />
     )
   )}
   ```

Key: Use isCulpabilite type guard to determine which panel to render.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - selectedEmotion state defined
    - isCulpabilite type guard imported and used
    - Both EmotionPanel and CulpabilitePanel conditionally rendered
  </verify>
  <done>
    - Clicking any emotion card opens appropriate panel
    - Culpabilite opens CulpabilitePanel, others open EmotionPanel
    - Panel closes when onClose called
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire panels into PleasantSentimentsPage</name>
  <files>
    src/components/emotions/PleasantSentimentsPage.tsx
  </files>
  <action>
Update `src/components/emotions/PleasantSentimentsPage.tsx`:

1. **Add imports:**
   ```typescript
   import type { Sentiment } from '../../types/emotions';
   import { SentimentPanel } from '../panel/SentimentPanel';
   ```

2. **Add state for selected sentiment:**
   ```typescript
   const [selectedSentiment, setSelectedSentiment] = useState<Sentiment | null>(null);
   ```

3. **Update handleCardClick:**
   ```typescript
   const handleCardClick = (sentiment: Sentiment) => {
     setSelectedSentiment(sentiment);
   };
   ```

4. **Update EmotionCard onClick:**
   ```tsx
   onClick={() => handleCardClick(sentiment)}
   ```

5. **Render SentimentPanel:**
   ```tsx
   {/* After the grid div */}
   {selectedSentiment && (
     <SentimentPanel
       sentiment={selectedSentiment}
       icon={sentimentIcons[selectedSentiment.id]}
       isOpen={selectedSentiment !== null}
       onClose={() => setSelectedSentiment(null)}
     />
   )}
   ```

This is simpler than emotions page since all sentiments use the same panel type.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - selectedSentiment state defined
    - SentimentPanel imported and rendered
  </verify>
  <done>
    - Clicking any sentiment card opens SentimentPanel
    - Panel displays correct sentiment data
    - Panel closes when onClose called
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete slide-in panel system for emotions and sentiments:
- SlidePanel with dialog, swipe-to-close, backdrop click
- EmotionPanel for 6 standard emotions
- SentimentPanel for 6 sentiments
- CulpabilitePanel with 2-level navigation for guilt
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:5173

**Test Unpleasant Emotions:**
3. Click "Quand ca ne va pas" on home page
4. Tap "Colere" card - panel should slide up from bottom with:
   - Header showing "Colere" and X button
   - Variations section with pill badges
   - Declencheurs, Reactions defensives, Besoins as bullet lists
5. Close panel by:
   - Tapping X button (should close)
   - Pressing Escape key (should close)
   - Tapping dark backdrop (should close)
   - Swiping down on panel (should close)
6. Test "Culpabilite" card:
   - Should show 4 sub-cards in 2x2 grid
   - Tap one sub-card - shows detail view with back arrow
   - Tap back arrow - returns to sub-card selection
   - Tap X - closes entire panel

**Test Pleasant Sentiments:**
7. Go back, click "Quand ca va bien"
8. Tap any sentiment card - panel shows:
   - Variations, Declencheurs, Besoins satisfaits (3 sections, no reactions)

**Test Accessibility:**
9. Open any panel and press Tab repeatedly:
   - Focus should cycle within panel only (trapped)
10. With panel open, press Escape - should close
11. After closing, focus should return to the card that was clicked

**Test Reduced Motion:**
12. In browser dev tools, emulate prefers-reduced-motion
13. Open a panel - should appear instantly (no slide animation)

**Expected outcomes:**
- All panels slide up smoothly (300ms)
- Content is scrollable if long
- Keyboard navigation works
- Swipe gesture works on mobile/touch
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks:

1. **Build check:**
   ```bash
   npm run build
   ```
   Should complete without errors.

2. **Dev server test:**
   ```bash
   npm run dev
   ```
   Manually test panel interactions.

3. **Type check:**
   ```bash
   npx tsc --noEmit
   ```
   No type errors.
</verification>

<success_criteria>
- Tapping any emotion card opens its panel
- Tapping any sentiment card opens its panel
- Culpabilite shows 4 sub-cards with proper back navigation
- Panel closes via: X button, Escape, backdrop click, swipe down
- Focus trapped in panel while open
- Focus returns to trigger element after close
- Reduced motion preference respected
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/03-slide-in-panel-details/03-03-SUMMARY.md`
</output>
